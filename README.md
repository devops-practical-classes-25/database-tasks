# Задание №1 - Нормализация базы данных для интернет-магазина

Вам дана исходная таблица Orders, в которой хранятся данные о заказах клиентов в интернет-магазине. В текущем виде таблица содержит избыточность данных и нарушение принципов нормализации. Ваша задача — выполнить нормализацию базы данных, выделив отдельные сущности и установив связи между ними.

## Исходная таблица заказов (ненормализованная)

| order_id | customer_name | customer_email   | product_name | product_price | quantity | order_date  |
|----------|--------------|------------------|--------------|--------------|----------|-------------|
| 1        | Иван Петров  | ivan@mail.com  | Телефон      | 20000        | 1        | 2024-03-10  |
| 2        | Анна Иванова | anna@mail.com  | Ноутбук      | 60000        | 1        | 2024-03-12  |
| 3        | Иван Петров  | ivan@mail.com  | Телефон      | 20000        | 2        | 2024-03-15  |
| 4        | Анна Иванова | anna@mail.com  | Планшет      | 30000        | 1        | 2024-03-16  |

**Задачи** :

1. Определите основные недостатки текущей структуры данных (избыточность, аномалии вставки, обновления, удаления).

2. Нормализуйте базу данных, выделив отдельные таблицы для каждой сущности (клиенты, заказы, товары, позиции заказа).

3. Опишите связи между таблицами с помощью первичных и внешних ключей.

4. Напишите SQL-скрипты для создания новых таблиц.

5. Добавьте тестовые данные (не менее 2-3 записей в каждой таблице).

6. Напишите SQL-запрос, который позволяет получить список всех заказов с указанием клиента, наименования товаров и их количества.

**Ожидаемая структура после нормализации**: 

+ Customer (id, name, email)

+ Product (id, name, price)

+ Order (id, customer_id, order_date)

+ Order_Item (id, order_id, product_id, quantity)

## Теоретическая информация

База данных (БД) – это организованный набор данных, который структурирован таким образом, чтобы обеспечивать удобное хранение, поиск и обработку информации.  
Системы управления базами данных (СУБД) позволяют пользователям эффективно взаимодействовать с данными, выполнять запросы и обеспечивать их целостность.  

Существует несколько типов баз данных:  
- **Реляционные (SQL)** – основаны на таблицах, между которыми устанавливаются связи (PostgreSQL, MySQL, SQLite).  
- **Документные (NoSQL)** – хранят данные в виде документов (MongoDB, CouchDB).  
- **Графовые** – ориентированы на работу со сложными взаимосвязями (Neo4j).  

Данный проект использует **реляционную модель**, реализованную в PostgreSQL.

## Основные принципы реляционных баз данных

1. **Таблицы (Tables)** – основная структура хранения данных.
2. **Строки (Rows)** – представляют конкретную запись в таблице.
3. **Столбцы (Columns)** – определяют тип данных, которые можно хранить в ячейке.
4. **Первичный ключ (Primary Key, PK)** – уникальный идентификатор записи.
5. **Внешний ключ (Foreign Key, FK)** – устанавливает связь между таблицами.
6. **Ограничения (Constraints)**:
   - `NOT NULL` – поле не может быть пустым.
   - `UNIQUE` – значения в столбце должны быть уникальными.
   - `CHECK` – проверка соответствия значения условиям.
   - `DEFAULT` – устанавливает значение по умолчанию.

## Инструкция по запуску

### 1. Запуск PostgreSQL и pgAdmin в Docker-контейнерах

Для запуска PostgreSQL и pgAdmin используйте Docker Compose. Убедитесь, что у вас установлены Docker и Docker Compose.

1. Убедитесь, что в корне проекта присутствует и заполнен файл .env.local.
2. Убедитесь, что порты 5433 и 5434 свободны на вашем компьютере.
3. Запустите контейнеры:

```bash
docker compose -f docker-compose.local.yml --env-file=.env.local  up -d
```

Это команда:
- Запускает контейнеры PostgreSQL и pgAdmin.
- При первом запуске контейнера с PostgreSQL применяется SQL-скрипт init/sql/init.sql для инициализации базы данных. В создаваемой базе данных выполняются все команды указанные в файле init.sql.

После запуска:
- PostgreSQL будет доступен на localhost:5433.
- pgAdmin будет доступен на localhost:5434.
- Подключитесь к PostgreSQL через pgAdmin, используя:
    * Host: postgres
    * Port: 5432
    * Username: postgres
    * Password: postgres
    * Database: postgres

### 2. Остановка контейнеров

Чтобы остановить и удалить контейнеры, выполните:

```bash
docker compose -f docker-compose.local.yml --env-file=.env.local  down -v
```

Чтобы остановить и удалить контейнеры, а также удалить volumes с данными, выполните:

```bash
docker compose -f docker-compose.local.yml --env-file=.env.local  down -v
```

### 3. Организация тестирования базы данных

Тестирование базы данных в проекте организовано с использованием библиотеки `pytest` и `SQLAlchemy`. Тесты проверяют корректность подключения к базе данных, а также выполнение SQL-запросов и наличие ожидаемых данных в таблицах.

#### Структура пакета с тестами:

- conftest.py: Содержит фикстуры для создания подключения к базе данных и управления сессиями SQLAlchemy.
- test_database.py: Содержит тесты, которые проверяют подключение к базе данных и выполнение SQL-запросов.
- config.py: Содержит класс Settings, который загружает конфигурацию для подключения к базе данных из переменных окружения или файла .env.

#### Зависимости для тестирования

Для тестирования базы данных используются следующие зависимости:
- pytest: для написания и запуска тестов.
- SQLAlchemy: для работы с базой данных.
- psycopg2-binary: драйвер для подключения к PostgreSQL.

Зависимости указаны в конфигурационном файле pyproject.toml и устанавливаются автоматически при выполнении команды poetry install.

#### Запуск тестов

Перед запуском тестов убедитесь, что Docker-контейнер с PostgreSQL запущен.

Перед первым запуском тестов:
1. Создайте и активируйте виртуальное окружение
    ```bash
    python3 -m venv .venv
    source .venv/bin/activate
    ```
2. Установите и настройте Poetry для создания виртуальных окружений в проекте
    ```bash
    pip install poetry
    poetry config virtualenvs.in-project true
    ```
3. Установите зависимости проекта:
    ```bash
    poetry install
    ```

Запустить тесты можно с помощью команды:
    ```bash
    poetry run pytest -v
    ```