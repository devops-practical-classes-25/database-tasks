# Задание №4 - Работа с хранимыми процедурами и триггерами

**Цель**: Освоить создание и использование хранимых процедур, триггеров и транзакций в базе данных.

В ресторане клиенты делают заказы, которые состоят из нескольких блюд. Необходимо разработать базу данных, позволяющую хранить информацию о клиентах, заказах и блюдах.

**Требования:**

1. Создать таблицы:

   + customers: содержат информацию о посетителях ресторана.
   + orders: фиксируют, какие клиенты сделали заказы и когда.
   + menu_items: содержат список блюд с их ценами.
   + order_items: показывает, какие блюда входят в конкретный заказ.

2. Разработать хранимую процедуру place_order, которая автоматически создает заказ и добавляет в него блюда.

3. Создать триггер, который при добавлении заказа автоматически рассчитывает его итоговую стоимость.
   
4. Добавить тестовые данные, чтобы проверить работу системы.

    Таблица customers (Покупатели):

    + Иван Иванов — ivan@example.com

    + Мария Смирнова — maria@example.com

    Таблица menu_items (Меню):

    + Пицца — 500.00 рублей

    + Салат — 250.00 рублей

    + Суп — 300.00 рублей

**Пример работы системы:**

1. Клиент Иван Иванов заказывает пиццу и салат.

2. Хранимая процедура создает новый заказ и добавляет в него выбранные блюда.

3. Триггер автоматически подсчитывает итоговую стоимость заказа.

## Теоретическая информация

### Хранимые процедуры

**Хранимые процедуры** - это предварительно скомпилированные наборы SQL-инструкций, которые хранятся в базе данных и могут быть вызваны по имени.

Основные характеристики:

+ Могут принимать входные параметры

+ Могут возвращать значения

+ Могут содержать сложную логику с условиями и циклами

+ Могут вызывать другие процедуры

Синтаксис создания процедуры:

```sql

CREATE PROCEDURE procedure_name(parameters)
BEGIN
    -- SQL-операторы
END
```

### Триггеры

**Триггеры** - это специальные хранимые процедуры, которые автоматически выполняются при наступлении определенного события в таблице (INSERT, UPDATE, DELETE).

Типы триггеров:

+ BEFORE (выполняются до операции)

+ AFTER (выполняются после операции)

+ INSTEAD OF (заменяют операцию, в некоторых СУБД)

Основные характеристики:

+ Выполняются автоматически при указанном событии

+ Имеют доступ к данным до и после изменения (через псевдонимы OLD и NEW)

+ Не могут принимать параметры явно

+ Не возвращают значения

Синтаксис создания триггера:

``` sql

CREATE TRIGGER trigger_name
[BEFORE|AFTER|INSTEAD OF] [INSERT|UPDATE|DELETE]
ON table_name
FOR EACH ROW
BEGIN
    -- SQL-операторы
END
```

## Инструкция по запуску

### 1. Запуск PostgreSQL и pgAdmin в Docker-контейнерах

Для запуска PostgreSQL и pgAdmin используйте Docker Compose. Убедитесь, что у вас установлены Docker и Docker Compose.

1. Убедитесь, что в корне проекта присутствует и заполнен файл .env.local.
2. Убедитесь, что порты 5433 и 5434 свободны на вашем компьютере.
3. Запустите контейнеры:

```bash
docker compose -f docker-compose.local.yml --env-file=.env.local  up -d
```

Это команда:
- Запускает контейнеры PostgreSQL и pgAdmin.
- При первом запуске контейнера с PostgreSQL применяется SQL-скрипт init/sql/init.sql для инициализации базы данных. В создаваемой базе данных выполняются все команды указанные в файле init.sql.

После запуска:
- PostgreSQL будет доступен на localhost:5433.
- pgAdmin будет доступен на localhost:5434.
- Подключитесь к PostgreSQL через pgAdmin, используя:
    * Host: postgres
    * Port: 5432
    * Username: postgres
    * Password: postgres
    * Database: postgres

### 2. Остановка контейнеров

Чтобы остановить и удалить контейнеры, выполните:

```bash
docker compose -f docker-compose.local.yml --env-file=.env.local  down
```

Чтобы остановить и удалить контейнеры, а также удалить volumes с данными, выполните:

```bash
docker compose -f docker-compose.local.yml --env-file=.env.local  down -v
```

### 3. Организация тестирования базы данных

Тестирование базы данных в проекте организовано с использованием библиотеки `pytest` и `SQLAlchemy`. Тесты проверяют корректность подключения к базе данных, а также выполнение SQL-запросов и наличие ожидаемых данных в таблицах.

#### Структура пакета с тестами:

- conftest.py: Содержит фикстуры для создания подключения к базе данных и управления сессиями SQLAlchemy.
- test_database.py: Содержит тесты, которые проверяют подключение к базе данных и выполнение SQL-запросов.
- config.py: Содержит класс Settings, который загружает конфигурацию для подключения к базе данных из переменных окружения или файла .env.

#### Зависимости для тестирования

Для тестирования базы данных используются следующие зависимости:
- pytest: для написания и запуска тестов.
- SQLAlchemy: для работы с базой данных.
- psycopg2-binary: драйвер для подключения к PostgreSQL.

Зависимости указаны в конфигурационном файле pyproject.toml и устанавливаются автоматически при выполнении команды poetry install.

#### Запуск тестов

Перед запуском тестов убедитесь, что Docker-контейнер с PostgreSQL запущен.

Перед первым запуском тестов:
1. Создайте и активируйте виртуальное окружение
    ```bash
    python3 -m venv .venv
    source .venv/bin/activate
    ```
2. Установите и настройте Poetry для создания виртуальных окружений в проекте
    ```bash
    pip install poetry
    poetry config virtualenvs.in-project true
    ```
3. Установите зависимости проекта:
    ```bash
    poetry install
    ```

Запустить тесты можно с помощью команды:
    ```bash
    poetry run pytest -v
    ```