# Задание №2 - Нормализация базы данных для интернет-магазина

Дана исходная таблица `Orders`, в которой хранятся данные о заказах клиентов в интернет-магазине. В текущем виде таблица содержит избыточность данных и нарушение принципов нормализации. Ваша задача — выполнить нормализацию базы данных, выделив отдельные сущности и установив связи между ними.

## Исходная таблица заказов (ненормализованная)

| order_id | customer_name | customer_email   | product_name | product_price | quantity | order_date  |
|----------|--------------|------------------|--------------|--------------|----------|-------------|
| 1        | Иван Петров  | ivan@mail.com  | Телефон      | 20000        | 1        | 2024-03-10  |
| 2        | Анна Иванова | anna@mail.com  | Ноутбук      | 60000        | 1        | 2024-03-12  |
| 3        | Иван Петров  | ivan@mail.com  | Телефон      | 20000        | 2        | 2024-03-15  |
| 4        | Анна Иванова | anna@mail.com  | Планшет      | 30000        | 1        | 2024-03-16  |

**Задачи** :

1. Определите основные недостатки текущей структуры данных (избыточность, аномалии вставки, обновления, удаления).

2. Нормализуйте базу данных, выделив отдельные таблицы для каждой сущности (клиенты, заказы, товары, позиции заказа).

3. Напишите SQL-скрипты для создания новых таблиц (запрос необходимо писать в файле `init.sql` в папке `init`).

4. Добавьте тестовые данные (не менее 2-3 записей в каждой таблице).

5. Напишите SQL-запрос, который позволяет получить список всех заказов с указанием клиента, наименования товаров и их количества.

## Теоретическая информация

### Нормализация баз данных

Нормализация — процесс организации данных в базе для уменьшения избыточности и предотвращения аномалий. Основные нормальные формы:
1. **1НФ**: 
   - Все атрибуты атомарны (неделимы).
   - Нет повторяющихся групп.
2. **2НФ**:
   - Таблица находится в 1НФ.
   - Все неключевые атрибуты зависят от первичного ключа целиком.
3. **3НФ**:
   - Таблица находится в 2НФ.
   - Нет транзитивных зависимостей (неключевые атрибуты не зависят друг от друга).

## Пример нормализации базы данных

**Исходная таблица (ненормализованная)**:

| student_id | student_name | course_name  | enrollment_date |
|------------|-------------|-------------|----------------|
| 1          | Иван Петров | Математика  | 2024-01-10     |
| 2          | Анна Иванова | Физика      | 2024-01-12     |
| 3          | Иван Петров | Физика      | 2024-01-15     |

**Проблемы исходной таблицы:**

- **Дублирование данных**: имена студентов повторяются.
- **Аномалии обновления**: если студент сменит фамилию, нужно менять несколько строк.
- **Аномалии удаления**: если удалить последнюю запись о студенте, его данные теряются.

### Нормализация базы данных

1. Выделяем таблицу `Students`

```sql
CREATE TABLE Students (
    student_id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL
);
```
| student_id | name |
|------------|-------------|
| 1          | Иван Петров |
| 2          | Анна Иванова |

1. Выделяем таблицу `Courses`

```sql
CREATE TABLE Courses (
    course_id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL
);

```

| course_id | name |
|------------|-------------|
| 1          | Математика |
| 2          | Физика |

1. Создаем таблицу `Enrollment` (Записи на курсы)

```sql
CREATE TABLE Enrollment (
    enrollment_id SERIAL PRIMARY KEY,
    student_id INT NOT NULL,
    course_id INT NOT NULL,
    enrollment_date DATE NOT NULL,
    FOREIGN KEY (student_id) REFERENCES Students(student_id),
    FOREIGN KEY (course_id) REFERENCES Courses(course_id)
);
```

| enrollment_id | student_id | course_id | enrollment_date |
|--------------|------------|-----------|-----------------|
| 1            | 1          | 1         | 2024-01-10      |
| 2            | 2          | 2         | 2024-01-12      |
| 3            | 1          | 2         | 2024-01-15      |

**Итог:**

✅ Убрали избыточность данных.

✅ Упрощено обновление информации.

✅ Устранены аномалии удаления и вставки.

## Инструкция по запуску

### 1. Запуск PostgreSQL и pgAdmin в Docker-контейнерах

Для запуска PostgreSQL и pgAdmin используйте Docker Compose. Убедитесь, что у вас установлены Docker и Docker Compose.

1. Убедитесь, что в корне проекта присутствует и заполнен файл .env.local.
2. Убедитесь, что порты 5433 и 5434 свободны на вашем компьютере.
3. Запустите контейнеры:

```bash
docker compose -f docker-compose.local.yml --env-file=.env.local  up -d
```

Это команда:
- Запускает контейнеры PostgreSQL и pgAdmin.
- При первом запуске контейнера с PostgreSQL применяется SQL-скрипт init/sql/init.sql для инициализации базы данных. В создаваемой базе данных выполняются все команды указанные в файле init.sql.

После запуска:
- PostgreSQL будет доступен на localhost:5433.
- pgAdmin будет доступен на localhost:5434.
- Подключитесь к PostgreSQL через pgAdmin, используя:
    * Host: postgres
    * Port: 5432
    * Username: postgres
    * Password: postgres
    * Database: postgres

### 2. Остановка контейнеров

Чтобы остановить и удалить контейнеры, выполните:

```bash
docker compose -f docker-compose.local.yml --env-file=.env.local  down
```

Чтобы остановить и удалить контейнеры, а также удалить volumes с данными, выполните:

```bash
docker compose -f docker-compose.local.yml --env-file=.env.local  down -v
```

### 3. Организация тестирования базы данных

Тестирование базы данных в проекте организовано с использованием библиотеки `pytest` и `SQLAlchemy`. Тесты проверяют корректность подключения к базе данных, а также выполнение SQL-запросов и наличие ожидаемых данных в таблицах.

#### Структура пакета с тестами:

- conftest.py: Содержит фикстуры для создания подключения к базе данных и управления сессиями SQLAlchemy.
- test_database.py: Содержит тесты, которые проверяют подключение к базе данных и выполнение SQL-запросов.
- config.py: Содержит класс Settings, который загружает конфигурацию для подключения к базе данных из переменных окружения или файла .env.

#### Зависимости для тестирования

Для тестирования базы данных используются следующие зависимости:
- pytest: для написания и запуска тестов.
- SQLAlchemy: для работы с базой данных.
- psycopg2-binary: драйвер для подключения к PostgreSQL.

Зависимости указаны в конфигурационном файле pyproject.toml и устанавливаются автоматически при выполнении команды poetry install.

#### Запуск тестов

Перед запуском тестов убедитесь, что Docker-контейнер с PostgreSQL запущен.

Перед первым запуском тестов:
1. Создайте и активируйте виртуальное окружение
    ```bash
    python3 -m venv .venv
    source .venv/bin/activate
    ```
2. Установите и настройте Poetry для создания виртуальных окружений в проекте
    ```bash
    pip install poetry
    poetry config virtualenvs.in-project true
    ```
3. Установите зависимости проекта:
    ```bash
    poetry install
    ```

Запустить тесты можно с помощью команды:
    ```bash
    poetry run pytest -v
    ```