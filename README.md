# Задание №1 - Разработка базы данных для библиотеки

Создать схему базы данных, позволяющую хранить информацию о книгах, авторах и читателях. Необходимо обеспечить целостность данных с помощью первичных и внешних ключей, а также предусмотреть наполнение базы тестовыми данными.
Для выполнения необходимо: 

1. Создать таблицы в базе данных, следуя описанной структуре (Все SQL-скрипты необходимо писать в файле: `init/init.sql`).
2. Настроить связи между таблицами с помощью FOREIGN KEY.
3. Добавить ограничения, такие как UNIQUE, NOT NULL.
4. Заполнить таблицы тестовыми данными (не менее 2-3 записей в каждой).
5. Написать SQL-запрос, который выбирает список книг, которые находятся у читателей на руках (не возвращены).

## Требования к базе данных

1. Реализовать таблицу авторов `author`
    * `id` (serial, PK) – Уникальный идентификатор автора.
    * `name` (varchar(255), NOT NULL) – Полное имя автора - должен быть уникальным сруди авторов
    * `birth_year` (integer, NULL) – Год рождения автора (может быть пустым, если неизвестен).
  
2. Реализовать таблицу книг `book`:
    * `id` (serial, PK) – Уникальный идентификатор книги.
    * `title` (varchar(255), NOT NULL) – Название книги.
    * `author_id` (integer, NOT NULL, FK → author.id) – Автор книги.
    * `year_published` (integer, NOT NULL) – Год издания.
  
3. Реализовать таблицу читателей `reader`: 
    * `id` (serial, PK) – Уникальный идентификатор читателя.
    * `name` (varchar(255), NOT NULL) – Имя читателя.
    * `email` (varchar(255), UNIQUE, NOT NULL) – Email читателя.

4. Реализовать таблицу с информацией о выдаче книг:
    * `id` (serial, PK) – Уникальный идентификатор выдачи.
    * `book_id` (integer, NOT NULL, FK → book.id) – Выданная книга.
    * `reader_id` (integer, NOT NULL, FK → reader.id) – Читатель, взявший книгу.
    * `loan_date` (date, NOT NULL) – Дата выдачи.
    * `return_date` (date, NULL) – Дата возврата (NULL, если книга еще не возвращена).

## Теоретическая информация

База данных (БД) – это организованный набор данных, который структурирован таким образом, чтобы обеспечивать удобное хранение, поиск и обработку информации.  
Системы управления базами данных (СУБД) позволяют пользователям эффективно взаимодействовать с данными, выполнять запросы и обеспечивать их целостность.  

Существует несколько типов баз данных:  
- **Реляционные (SQL)** – основаны на таблицах, между которыми устанавливаются связи (PostgreSQL, MySQL, SQLite).  
- **Документные (NoSQL)** – хранят данные в виде документов (MongoDB, CouchDB).  
- **Графовые** – ориентированы на работу со сложными взаимосвязями (Neo4j).  

Данный проект использует **реляционную модель**, реализованную в PostgreSQL.

## Основные принципы реляционных баз данных

1. **Таблицы (Tables)** – основная структура хранения данных.
2. **Строки (Rows)** – представляют конкретную запись в таблице.
3. **Столбцы (Columns)** – определяют тип данных, которые можно хранить в ячейке.
4. **Первичный ключ (Primary Key, PK)** – уникальный идентификатор записи.
5. **Внешний ключ (Foreign Key, FK)** – устанавливает связь между таблицами.
6. **Ограничения (Constraints)**:
   - `NOT NULL` – поле не может быть пустым.
   - `UNIQUE` – значения в столбце должны быть уникальными.
   - `CHECK` – проверка соответствия значения условиям.
   - `DEFAULT` – устанавливает значение по умолчанию.

## Инструкция по запуску

### 1. Запуск PostgreSQL и pgAdmin в Docker-контейнерах

Для запуска PostgreSQL и pgAdmin используйте Docker Compose. Убедитесь, что у вас установлены Docker и Docker Compose.

1. Убедитесь, что в корне проекта присутствует и заполнен файл .env.local.
2. Убедитесь, что порты 5433 и 5434 свободны на вашем компьютере.
3. Запустите контейнеры:

```bash
docker compose -f docker-compose.local.yml --env-file=.env.local  up -d
```

Это команда:
- Запускает контейнеры PostgreSQL и pgAdmin.
- При первом запуске контейнера с PostgreSQL применяется SQL-скрипт init/sql/init.sql для инициализации базы данных. В создаваемой базе данных выполняются все команды указанные в файле init.sql.

После запуска:
- PostgreSQL будет доступен на localhost:5433.
- pgAdmin будет доступен на localhost:5434.
- Подключитесь к PostgreSQL через pgAdmin, используя:
    * Host: postgres
    * Port: 5432
    * Username: postgres
    * Password: postgres
    * Database: postgres

### 2. Остановка контейнеров

Чтобы остановить и удалить контейнеры, выполните:

```bash
docker compose -f docker-compose.local.yml --env-file=.env.local  down -v
```

Чтобы остановить и удалить контейнеры, а также удалить volumes с данными, выполните:

```bash
docker compose -f docker-compose.local.yml --env-file=.env.local  down -v
```

### 3. Организация тестирования базы данных

Тестирование базы данных в проекте организовано с использованием библиотеки `pytest` и `SQLAlchemy`. Тесты проверяют корректность подключения к базе данных, а также выполнение SQL-запросов и наличие ожидаемых данных в таблицах.

#### Структура пакета с тестами:

- conftest.py: Содержит фикстуры для создания подключения к базе данных и управления сессиями SQLAlchemy.
- test_database.py: Содержит тесты, которые проверяют подключение к базе данных и выполнение SQL-запросов.
- config.py: Содержит класс Settings, который загружает конфигурацию для подключения к базе данных из переменных окружения или файла .env.

#### Зависимости для тестирования

Для тестирования базы данных используются следующие зависимости:
- pytest: для написания и запуска тестов.
- SQLAlchemy: для работы с базой данных.
- psycopg2-binary: драйвер для подключения к PostgreSQL.

Зависимости указаны в конфигурационном файле pyproject.toml и устанавливаются автоматически при выполнении команды poetry install.

#### Запуск тестов

Перед запуском тестов убедитесь, что Docker-контейнер с PostgreSQL запущен.

Перед первым запуском тестов:
1. Создайте и активируйте виртуальное окружение
    ```bash
    python3 -m venv .venv
    source .venv/bin/activate
    ```
2. Установите и настройте Poetry для создания виртуальных окружений в проекте
    ```bash
    pip install poetry
    poetry config virtualenvs.in-project true
    ```
3. Установите зависимости проекта:
    ```bash
    poetry install
    ```

Запустить тесты можно с помощью команды:
    ```bash
    poetry run pytest -v
    ```